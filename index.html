<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>‡πÅ‡∏ö‡∏ö‡∏ü‡∏≠‡∏£‡πå‡∏°‡πÄ‡∏ï‡∏¥‡∏°‡∏™‡∏ï‡πá‡∏≠‡∏Å‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</title>
  <style>
    :root{
      --brand:#0b5cff; --muted:#f6f7fb; --text:#222; --border:#e6e8ef;
    }
    *{box-sizing:border-box}
    body{font-family:system-ui,Segoe UI,Roboto,TH Sarabun New,sans-serif;background:#fff;margin:0;color:var(--text)}
    .wrap{max-width:920px;margin:24px auto;padding:0 16px}
    .card{background:#fff;border:1px solid var(--border);border-radius:14px;box-shadow:0 2px 12px rgba(0,0,0,.04);overflow:hidden;margin-bottom:16px}
    .head{background:linear-gradient(90deg,#0b5cff,#6ea8fe);color:#fff;padding:18px 16px}
    .head h1{font-size:20px;margin:0}
    .body{padding:16px}
    label{display:block;font-weight:600;margin:14px 0 6px}
    input[type="number"],input[type="text"],select{
      width:100%;padding:10px 12px;border:1px solid var(--border);border-radius:10px;outline:none
    }
    input[type="number"]:focus,select:focus,input[type="text"]:focus{border-color:#b6ccff;box-shadow:0 0 0 4px #e9f0ff}
    .row{display:grid;gap:12px}
    @media(min-width:720px){ .row{grid-template-columns: 1.2fr 1fr}}
    .selected{font-size:13px;color:#0a58ca;margin-top:8px}
    .divider{height:1px;background:var(--border);margin:14px 0}
    button{
      background:var(--brand);color:#fff;border:none;border-radius:10px;padding:12px 16px;font-size:16px;cursor:pointer
    }
    button:disabled{opacity:.6;cursor:not-allowed}
    .pill{display:inline-block;background:#eef3ff;color:#0b5cff;border:1px solid #dbe6ff;border-radius:999px;padding:4px 10px;font-size:12px}
    .success{background:#f0fff4;border:1px solid #c7f0d2;color:#146c2e;padding:10px;border-radius:10px}
    .error{background:#fff5f5;border:1px solid #ffd6d6;color:#b42318;padding:10px;border-radius:10px}
    .remove-btn{background:#e74c3c;margin-top:10px}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <div class="head">
        <h1>‡πÄ‡∏ï‡∏¥‡∏°‡∏™‡∏ï‡πá‡∏≠‡∏Å‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</h1>
        <div class="pill">‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥‡∏à‡∏≤‡∏Å Google Sheet</div>
      </div>
      <div class="body">

        <!-- ‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡∏≠‡πâ‡∏≤‡∏á‡∏≠‡∏¥‡∏á -->
        <label>‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡∏≠‡πâ‡∏≤‡∏á‡∏≠‡∏¥‡∏á</label>
        <input id="docRef" type="text" placeholder="‡πÄ‡∏ä‡πà‡∏ô PO-12345 ‡∏´‡∏£‡∏∑‡∏≠ INV-67890" />

        <!-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡πâ‡∏≤‡∏ô -->
        <label style="margin-top:14px;">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡πâ‡∏≤‡∏ô</label>
        <select id="shopSelect" disabled>
          <option value="">‚Äî ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏£‡πâ‡∏≤‡∏ô ‚Äî</option>
        </select>

        <div class="divider"></div>

        <div id="items-container"></div>
        <button style="margin-top:8px" onclick="addItem()">+ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</button>
        <div class="divider"></div>
        <button id="btnSubmit" disabled>‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</button>
        <div id="result" style="margin-top:12px"></div>
      </div>
    </div>
  </div>

  <script>
    const SPREADSHEET_ID = "1I9jAyU7UHXxbizMxpT5RghoyfnnYkBPetS39hS1BzH0";
    const ITEM_SHEET = "ListItem";
    const SHOP_SHEET = "CompanyName";
    const WEBHOOK_URL = "https://n8n-p2sw2ng.p2scalw2ng.xyz/webhook-test/StockIN";

    let productList = [];
    let shopList = [];

    async function fetchSheet(sheetName) {
      const url = `https://docs.google.com/spreadsheets/d/${SPREADSHEET_ID}/gviz/tq?tqx=out:json&sheet=${encodeURIComponent(sheetName)}`;
      const res = await fetch(url);
      const text = await res.text();
      const jsonStr = text.substring(text.indexOf("{"), text.lastIndexOf("}") + 1);
      const data = JSON.parse(jsonStr);
      return data.table.rows || [];
    }

    async function fetchListItems() {
      const rows = await fetchSheet(ITEM_SHEET);
      return rows.slice(1).map(r => {
        const c = r.c || [];
        const sku = (c[0]?.f ?? String(c[0]?.v ?? "")).trim();
        const name = (c[1]?.f ?? String(c[1]?.v ?? "")).trim();
        return { sku, name };
      }).filter(x => x.sku || x.name);
    }

    async function fetchShops() {
      const rows = await fetchSheet(SHOP_SHEET);
      return rows.slice(1).map(r => {
        const c = r.c || [];
        const shop = (c[0]?.f ?? String(c[0]?.v ?? "")).trim();
        return shop;
      }).filter(Boolean);
    }

    function buildItemBlock(){
      const div = document.createElement('div');
      div.className = 'card';
      div.innerHTML = `
        <div class="body">
          <label>‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</label>
          <select class="product" disabled>
            <option value="">‚Äî ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ ‚Äî</option>
          </select>
          <div class="selected selectedInfo" style="display:none"></div>
          <div class="row">
            <div>
              <label>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô</label>
              <input class="qty" type="number" min="1" step="1" placeholder="‡πÄ‡∏ä‡πà‡∏ô 1" />
            </div>
            <div>
              <label>‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏ (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ)</label>
              <input class="note" type="text" placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡∏£‡∏±‡∏ö‡πÄ‡∏Ç‡πâ‡∏≤, ‡∏Ñ‡∏∑‡∏ô‡∏Ç‡∏≠‡∏á, ‡∏õ‡∏£‡∏±‡∏ö‡∏™‡∏ï‡πá‡∏≠‡∏Å" />
            </div>
          </div>
          <button class="remove-btn" onclick="this.closest('.card').remove();checkBtnSubmit()">‡∏•‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ô‡∏µ‡πâ</button>
        </div>
      `;
      return div;
    }

    function fillOptions(select, list, placeholder, valueKey = "sku", textKey = "name"){
      select.innerHTML = `<option value="">‚Äî ${placeholder} ‚Äî</option>`;
      list.forEach(r=>{
        const opt=document.createElement('option');
        if(typeof r === "string"){
          opt.value = r; opt.textContent = r;
        }else{
          opt.value=r[valueKey];
          opt.dataset.name=r[textKey];
          opt.textContent=`${r[textKey]} ‚Äî ${r[valueKey]}`;
        }
        select.appendChild(opt);
      });
      select.disabled = list.length===0;
    }

    function addItem(){
      const container = document.getElementById('items-container');
      const block = buildItemBlock();
      container.appendChild(block);
      const select = block.querySelector('.product');
      fillOptions(select, productList, "‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤");
      select.addEventListener('change',()=>{
        const name=select.selectedOptions[0]?.dataset?.name||"";
        const selInfo=block.querySelector('.selectedInfo');
        if(select.value){
          selInfo.style.display='block';
          selInfo.textContent=`‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÅ‡∏•‡πâ‡∏ß: ${name} (‡∏£‡∏´‡∏±‡∏™: ${select.value})`;
        }else selInfo.style.display='none';
        checkBtnSubmit();
      });
      checkBtnSubmit();
    }

    function checkBtnSubmit(){
      const shopSelected = document.getElementById('shopSelect').value;
      const hasSelect = [...document.querySelectorAll('.product')].some(s=>s.value);
      document.getElementById('btnSubmit').disabled = !(shopSelected && hasSelect);
    }

    async function submitPayload(){
      const shop = document.getElementById('shopSelect').value;
      const docRef = document.getElementById('docRef').value;
      const payloads = [...document.querySelectorAll('#items-container .card')].map(b=>{
        const s = b.querySelector('.product');
        const sku = s.value;
        const name = s.selectedOptions[0]?.dataset?.name || "";
        const qty = parseInt(b.querySelector('.qty').value || "0", 10);
        const note = b.querySelector('.note').value;
        return { action:"stock_in", shop, doc_ref:docRef, sku, name, qty, note, timestamp_iso:new Date().toISOString() };
      }).filter(x=>x.sku);

      const resultDiv = document.getElementById('result');
      try {
        const resp = await fetch(WEBHOOK_URL, {
          method:'POST',
          headers:{'Content-Type':'application/json'},
          body:JSON.stringify(payloads)
        });
        const text = await resp.text();
        let respJson = {};
        try { respJson = JSON.parse(text); } catch {}
        resultDiv.innerHTML = `<div class="success">‡∏™‡πà‡∏á‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à üéâ<br><pre>${JSON.stringify(respJson||text,null,2)}</pre></div>`;
      } catch (err){
        resultDiv.innerHTML = `<div class="error">‡∏™‡πà‡∏á‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: ${err.message}</div>`;
      }
    }

    document.getElementById('btnSubmit').addEventListener('click',submitPayload);
    document.getElementById('shopSelect').addEventListener('change',checkBtnSubmit);

    (async function init(){
      [productList, shopList] = await Promise.all([fetchListItems(), fetchShops()]);
      fillOptions(document.getElementById('shopSelect'), shopList, "‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡πâ‡∏≤‡∏ô");
      addItem();
    })();
  </script>
</body>
</html>
